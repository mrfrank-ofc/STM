<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher Dashboard - St. Mary's High School</title>
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF and autoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* General Styles */
    :root {
      --primary: #003366;
      --secondary: #ffd700;
      --glass: rgba(255, 255, 255, 0.08);
      --bg-gradient: linear-gradient(45deg, #003d4d, #005f73);
      --text-color: #ffffff;
      --overlay: rgba(0, 0, 0, 0.4);
    }
    [data-theme="light"] {
      --primary: #00b4db;
      --secondary: #0083b0;
      --glass: rgba(0, 0, 0, 0.05);
      --bg-gradient: linear-gradient(45deg, #e0f7fa, #b2ebf2);
      --text-color: #1c1917;
      --overlay: rgba(255, 255, 255, 0.4);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }
    body {
      background: var(--bg-gradient);
      color: var(--text-color);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background 0.6s ease, color 0.6s ease;
    }
    header {
      background: var(--glass);
      backdrop-filter: blur(12px);
      padding: 1.2rem 5%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
    }
    .header-logo {
      height: 40px;
      margin-right: 10px;
      vertical-align: middle;
    }
    .container {
      padding: 180px 5% 100px;
      max-width: 1000px;
      margin: auto;
    }
    input, select, button {
      font-family: inherit;
    }
    /* Search Bar */
    #searchStudent {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: none;
      border-radius: 5px;
    }
    /* Student List */
    .student-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 2rem;
    }
    .student-card {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: 10px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    .student-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }
    .student-card h3 {
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    .student-card p {
      color: var(--text-color);
    }
    /* Marks Entry Form */
    #marksForm {
      display: none;
      background: var(--glass);
      padding: 1.5rem;
      border-radius: 10px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--primary);
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      background: var(--glass);
      color: var(--text-color);
    }
    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--primary);
      outline: none;
    }
    .form-group button,
    #marksForm button {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease;
    }
    .form-group button:hover,
    #marksForm button:hover {
      background: #002244;
    }
    /* Report Card */
    .report-card {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: 10px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }
    .report-card h3 {
      color: var(--primary);
      margin-bottom: 1rem;
    }
    .report-header p {
      margin: 0.3rem 0;
    }
    .report-card table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    .report-card th,
    .report-card td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .report-card th {
      background: var(--primary);
      color: white;
    }
    .report-card td button {
      padding: 0.5rem 1rem;
      margin-right: 0.5rem;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .report-card td button:hover {
      opacity: 0.9;
    }
    .edit-btn {
      background: var(--secondary);
      color: var(--primary);
    }
    .delete-btn {
      background: #ff4d4d;
      color: white;
    }
    .pdf-btn {
      background: var(--primary);
      color: white;
      margin-bottom: 1rem;
    }
    /* Chart Container */
    .chart-container {
      width: 100%;
      height: 300px;
    }
    /* Footer */
    footer {
      background: var(--glass);
      backdrop-filter: blur(12px);
      color: white;
      padding: 2rem 5%;
      text-align: center;
      position: fixed;
      width: 100%;
      bottom: 0;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <img src="https://i.ibb.co/yFJryv1y/mrfrankofc.jpg" alt="Logo" class="header-logo" />
      St. Mary's High - Teacher Dashboard
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <!-- Search Field -->
    <input type="text" id="searchStudent" placeholder="Search student by name..." onkeyup="filterStudents()" />

    <!-- Student List -->
    <h2>Student List</h2>
    <div id="studentList" class="student-list">
      <!-- Dynamically populated student cards -->
    </div>

    <!-- Marks Entry Form -->
    <form id="marksForm">
      <h2>Enter Marks for <span id="selectedStudent"></span></h2>
      <!-- New Year and Term fields -->
      <div class="form-group">
        <label for="yearInput">Year</label>
        <input type="text" id="yearInput" placeholder="Enter academic year (e.g., 2025)" />
      </div>
      <div class="form-group">
        <label for="termInput">Term</label>
        <select id="termInput">
          <option value="">Select Term</option>
          <option value="Term 1">Term 1</option>
          <option value="Term 2">Term 2</option>
          <option value="Term 3">Term 3</option>
        </select>
      </div>
      <!-- Subject Fields (up to 10) -->
      <div id="subjectFields">
        <!-- Dynamically generated subject fields -->
      </div>
      <button type="submit">Save Marks</button>
    </form>

    <!-- Report Card -->
    <div id="reportCard" class="report-card" style="display: none;">
      <!-- Report header with student info -->
      <div class="report-header" style="margin-bottom: 1rem;">
        <p>Name: <span id="reportName"></span></p>
        <p>Surname: <span id="reportSurname"></span></p>
        <p>Email: <span id="reportEmail"></span></p>
        <p>Year: <span id="reportYear"></span></p>
        <p>Term: <span id="reportTerm"></span></p>
      </div>
      <h3>Report Card</h3>
      <table>
        <thead>
          <tr>
            <th>Subject</th>
            <th>Marks</th>
            <th>Grade</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reportCardBody">
          <!-- Dynamically generated report card rows -->
        </tbody>
      </table>
      <button class="pdf-btn" onclick="exportPDF()">Download PDF</button>
      <div class="chart-container">
        <canvas id="performanceChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 St. Mary's High School. All rights reserved.</p>
  </footer>

  <!-- Firebase and App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      getDoc,
      doc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase config (using your original project settings)
    const firebaseConfig = {
      apiKey: "AIzaSyAR9J2Wz7Eu8dXRzDG8JNHcymLCUQUPJRo",
      authDomain: "deee-9ab53.firebaseapp.com",
      projectId: "deee-9ab53",
      storageBucket: "deee-9ab53.firebasestorage.app",
      messagingSenderId: "399732664479",
      appId: "1:399732664479:web:b84ac30e8266cc51761aaa",
      measurementId: "G-524ZPBX42B"
    };

    // Initialize Firebase
    const appFirebase = initializeApp(firebaseConfig);
    const db = getFirestore(appFirebase);

    // Global variables
    const studentList = document.getElementById("studentList");
    const marksForm = document.getElementById("marksForm");
    const reportCard = document.getElementById("reportCard");
    const reportCardBody = document.getElementById("reportCardBody");
    let performanceChart; // for Chart.js

    // Fetch and display all students
    async function fetchStudents() {
      try {
        const querySnapshot = await getDocs(collection(db, "students"));
        let students = [];
        querySnapshot.forEach((docSnap) => {
          let data = docSnap.data();
          data.id = docSnap.id;
          students.push(data);
        });
        // Sort students alphabetically by surname
        students.sort((a, b) => a.surname.localeCompare(b.surname));
        studentList.innerHTML = "";
        students.forEach((student) => {
          const card = document.createElement("div");
          card.className = "student-card";
          card.innerHTML = `
            <h3>${student.firstname} ${student.surname}</h3>
            <p>${student.email || ""}</p>
          `;
          card.addEventListener("click", () => openMarksForm(student));
          studentList.appendChild(card);
        });
      } catch (error) {
        console.error("Error fetching students:", error);
      }
    }

    // Filter students by search term
    window.filterStudents = () => {
      const search = document.getElementById("searchStudent").value.toLowerCase();
      document.querySelectorAll(".student-card").forEach((card) => {
        card.style.display = card.textContent.toLowerCase().includes(search)
          ? ""
          : "none";
      });
    };

    // Extract name and surname from email (expects format: firstname.lastname@domain)
    function extractNameSurname(email) {
      let name = "";
      let surname = "";
      if (email) {
        let local = email.split("@")[0];
        let parts = local.split(".");
        if (parts.length >= 2) {
          name = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
          surname = parts[1].charAt(0).toUpperCase() + parts[1].slice(1);
        } else {
          name = local;
        }
      }
      return { name, surname };
    }

    // Open marks entry form with (prefilled) subjects and year/term if available
    window.openMarksForm = (student) => {
      document.getElementById("selectedStudent").textContent =
        student.firstname + " " + student.surname;
      marksForm.style.display = "block";
      marksForm.dataset.studentId = student.id;
      const subjectFields = document.getElementById("subjectFields");
      subjectFields.innerHTML = "";
      // Prepopulate with existing marks if any
      const subjects = student.marks || {};
      const keys = Object.keys(subjects);
      for (let i = 0; i < 10; i++) {
        const subjectName = keys[i] || "";
        const marksVal = keys[i] ? subjects[keys[i]].marks : "";
        const gradeVal = keys[i] ? subjects[keys[i]].grade : "";
        subjectFields.innerHTML += `
          <div class="form-group">
            <label>Subject ${i + 1}</label>
            <input type="text" id="subject${i}" value="${subjectName}" placeholder="Enter subject name" />
            <input type="number" id="marks${i}" value="${marksVal}" placeholder="Enter marks" oninput="updateGrade(${i})"/>
            <select id="grade${i}">
              <option value="A" ${gradeVal === "A" ? "selected" : ""}>A</option>
              <option value="B" ${gradeVal === "B" ? "selected" : ""}>B</option>
              <option value="C" ${gradeVal === "C" ? "selected" : ""}>C</option>
              <option value="D" ${gradeVal === "D" ? "selected" : ""}>D</option>
              <option value="F" ${gradeVal === "F" ? "selected" : ""}>F</option>
            </select>
          </div>
        `;
      }
      // Prepopulate year and term if available
      document.getElementById("yearInput").value = student.year || "";
      document.getElementById("termInput").value = student.term || "";
    };

    // Auto-grade calculation on marks input
    window.updateGrade = (index) => {
      const marksInput = document.getElementById(`marks${index}`);
      const gradeSelect = document.getElementById(`grade${index}`);
      const marks = Number(marksInput.value);
      let grade = "F";
      if (!isNaN(marks)) {
        if (marks >= 90) grade = "A";
        else if (marks >= 80) grade = "B";
        else if (marks >= 70) grade = "C";
        else if (marks >= 60) grade = "D";
        else grade = "F";
      }
      gradeSelect.value = grade;
    };

    // Save marks (plus year and term) and display report card on form submission
    marksForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const studentId = marksForm.dataset.studentId;
      let marksData = {};
      for (let i = 0; i < 10; i++) {
        const subject = document.getElementById(`subject${i}`).value.trim();
        const marks = document.getElementById(`marks${i}`).value;
        const grade = document.getElementById(`grade${i}`).value;
        if (subject !== "" && marks !== "") {
          marksData[subject] = { marks: Number(marks), grade };
        }
      }
      const yearVal = document.getElementById("yearInput").value.trim();
      const termVal = document.getElementById("termInput").value;
      try {
        const studentRef = doc(db, "students", studentId);
        await setDoc(studentRef, { marks: marksData, year: yearVal, term: termVal }, { merge: true });
        alert("Marks saved successfully!");
        marksForm.reset();
        marksForm.style.display = "none";
        displayReportCard(studentId);
      } catch (error) {
        console.error("Error saving marks:", error);
        alert("Error saving marks. Please try again.");
      }
    });

    // Display report card with marks, actions, and analytics
    async function displayReportCard(studentId) {
      try {
        const studentRef = doc(db, "students", studentId);
        const studentSnap = await getDoc(studentRef);
        if (studentSnap.exists()) {
          const studentData = studentSnap.data();
          // Update report header details using email extraction
          const { name, surname } = extractNameSurname(studentData.email || "");
          document.getElementById("reportName").textContent = name;
          document.getElementById("reportSurname").textContent = surname;
          document.getElementById("reportEmail").textContent = studentData.email || "";
          document.getElementById("reportYear").textContent = studentData.year || "";
          document.getElementById("reportTerm").textContent = studentData.term || "";
          
          if (studentData.marks) {
            reportCard.style.display = "block";
            reportCardBody.innerHTML = "";
            let totalMarks = 0,
              count = 0;
            for (const [subject, data] of Object.entries(studentData.marks)) {
              reportCardBody.innerHTML += `
                <tr>
                  <td>${subject}</td>
                  <td>${data.marks}</td>
                  <td>${data.grade}</td>
                  <td>
                    <button class="edit-btn" onclick="editSubject('${studentId}', '${subject}')">Edit</button>
                    <button class="delete-btn" onclick="deleteSubject('${studentId}', '${subject}')">Delete</button>
                  </td>
                </tr>
              `;
              totalMarks += Number(data.marks);
              count++;
            }
            const avgMarks = count ? (totalMarks / count).toFixed(2) : 0;
            reportCardBody.innerHTML += `
              <tr>
                <td colspan="4">Average Marks: ${avgMarks}</td>
              </tr>
            `;
            updateChart(studentData.marks);
          } else {
            reportCard.style.display = "none";
          }
        }
      } catch (error) {
        console.error("Error displaying report card:", error);
      }
    }

    // Update performance chart using Chart.js
    function updateChart(marksData) {
      const ctx = document.getElementById("performanceChart").getContext("2d");
      const subjects = Object.keys(marksData);
      const marks = subjects.map((sub) => marksData[sub].marks);
      if (performanceChart) {
        performanceChart.destroy();
      }
      performanceChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [
            {
              label: "Marks",
              data: marks,
              backgroundColor: "rgba(0, 179, 219, 0.5)",
              borderColor: "rgba(0, 179, 219, 1)",
              borderWidth: 1,
            },
          ],
        },
        options: {
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }

    // Delete a subject from the student's marks
    window.deleteSubject = async (studentId, subject) => {
      if (confirm(`Are you sure you want to delete ${subject}?`)) {
        try {
          const studentRef = doc(db, "students", studentId);
          const studentSnap = await getDoc(studentRef);
          if (studentSnap.exists()) {
            const studentData = studentSnap.data();
            if (studentData.marks && studentData.marks[subject]) {
              delete studentData.marks[subject];
              await setDoc(studentRef, { marks: studentData.marks }, { merge: true });
              alert(`${subject} deleted successfully!`);
              displayReportCard(studentId);
            }
          }
        } catch (error) {
          console.error("Error deleting subject:", error);
        }
      }
    };

    // Edit a subject by reopening the marks form and highlighting the subject field
    window.editSubject = async (studentId, subject) => {
      try {
        const studentRef = doc(db, "students", studentId);
        const studentSnap = await getDoc(studentRef);
        if (studentSnap.exists()) {
          const studentData = studentSnap.data();
          studentData.id = studentId;
          openMarksForm(studentData);
          // Highlight the field for the subject after a short delay
          setTimeout(() => {
            for (let i = 0; i < 10; i++) {
              const subInput = document.getElementById(`subject${i}`);
              if (subInput && subInput.value === subject) {
                subInput.focus();
                subInput.style.border = "2px solid red";
                setTimeout(() => {
                  subInput.style.border = "";
                }, 2000);
                break;
              }
            }
          }, 100);
        }
      } catch (error) {
        console.error("Error editing subject:", error);
      }
    };

    // Export report card to PDF using jsPDF and autoTable
    window.exportPDF = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      // Retrieve header details
      const name = document.getElementById("reportName").textContent;
      const surname = document.getElementById("reportSurname").textContent;
      const email = document.getElementById("reportEmail").textContent;
      const year = document.getElementById("reportYear").textContent;
      const term = document.getElementById("reportTerm").textContent;
      // Add header to PDF
      doc.text(`Name: ${name}`, 14, 10);
      doc.text(`Surname: ${surname}`, 14, 20);
      doc.text(`Email: ${email}`, 14, 30);
      doc.text(`Year: ${year}`, 14, 40);
      doc.text(`Term: ${term}`, 14, 50);
      // Prepare table rows from reportCardBody
      let rows = [];
      document.querySelectorAll("#reportCardBody tr").forEach((tr) => {
        const cells = Array.from(tr.querySelectorAll("td")).map(
          (td) => td.textContent
        );
        rows.push(cells);
      });
      doc.autoTable({
        head: [["Subject", "Marks", "Grade", "Actions"]],
        body: rows,
        startY: 60,
      });
      doc.save("report_card.pdf");
    };

    // Load students on page load
    fetchStudents();
  </script>
</body>
</html>
